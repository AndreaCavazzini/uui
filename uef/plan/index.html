<html>
  <head>
    <title>Plan</title>
    <link rel="stylesheet" href="css/style.css" type="text/css" media="screen" charset="utf-8">  
    <link rel='stylehseet' href='lib/bootstrap/css/bootstrap.min.css' type='text/css'>  
    <link rel="stylesheet" type="text/css" href="http://stevendevooght.github.io/tinyMCE-mention/stylesheets/autocomplete.css"> 
    <script src='lib/jquery/jquery.js'></script>
    <script src='lib/bootstrap/js/bootstrap.min.js'></script>
    <script src='lib/tinymce/tinymce.min.js'></script>
    <script src='lib/list/list.min.js'></script>
  </head>
  <body>
  <div class='wrapper'>
    <div class="center">
    	<div id="contacts">
  <table class='table'>
    <thead>
      <tr>
        <th class="sort" data-sort="name">Name</th>
        <th class="sort" data-sort="age">Age</th>
        <th class="sort" data-sort="city">City</th>
        <th colspan="2">
          <input style='display:none;' type="text" class="search" placeholder="Search contact" />
        </th>
      </tr>
    </thead>
    <tbody class="list">
     
      <tr>
        <td class="id" style="display:none;">1</td>
        <td class="name"></td>
        <td class="age"></td>
        <td class="city"></td>
        <td class="edit"><button class="edit-item-btn">Edit</button></td>
        <td class="remove"><button id='remove-empty' class="remove-item-btn">Remove</button></td>
      </tr>
     <!-- <tr>
        <td class="id" style="display:none;">2</td>
        <td class="name">Jonas</td>
        <td class="age">-132</td>
        <td class="city">Berlin</td>
        <td class="edit"><button class="edit-item-btn">Edit</button></td>
        <td class="remove"><button class="remove-item-btn">Remove</button></td>
      </tr>
      <tr>
        <td class="id" style="display:none;">3</td>
        <td class="name">Gustaf</td>
        <td class="age">-23</td>
        <td class="city">Sundsvall</td>
        <td class="edit"><button class="edit-item-btn">Edit</button></td>
        <td class="remove"><button class="remove-item-btn">Remove</button></td>
      </tr>
      <tr>
        <td class="id" style="display:none;">4</td>
        <td class="name">Fredrik</td>
        <td class="age">26</td>
        <td class="city">Goteborg</td>
        <td class="edit"><button class="edit-item-btn">Edit</button></td>
        <td class="remove"><button class="remove-item-btn">Remove</button></td>
      </tr>-->
    </tbody>
  </table>
  <table>
    <td class="name">
      <input type="hidden" id="id-field" />
      <input type="text" id="name-field" placeholder="Name" />
    </td>
    <td class="age">
      <input type="text" id="age-field" placeholder="Age" />
    </td>
    <td class="city">
      <input type="text" id="city-field" placeholder="City" />
    </td>
    <td class="add">
      <button id="add-btn">Add</button>
      <button id="edit-btn">Edit</button>
    </td>
  </table>
</div>
    </div>
</div>
    <div class="container" style='z-index: 10'>
      <p>
        <label for="new-task">Add Item</label><textarea id="new-task" type="text"></textarea><button id='add-task'>Add</button>
      </p>
      <h3>Todo</h3>
      <ul id="incomplete-tasks">
      </ul>
      <h3>Completed</h3>
      <ul id="completed-tasks">
      </ul>
    </div>
    <script type="text/javascript" src="js/ui.js"></script>
    <script>
	var options = {
  valueNames: [ 'id', 'name', 'age', 'city' ]
};

// Init list
var contactList = new List('contacts', options);

var idField = $('#id-field'),
    nameField = $('#name-field'),
    ageField = $('#age-field'),
    cityField = $('#city-field'),
    addBtn = $('#add-btn'),
    editBtn = $('#edit-btn').hide(),
    removeBtns = $('.remove-item-btn'),
    editBtns = $('.edit-item-btn');

// Sets callbacks to the buttons in the list
refreshCallbacks();

addBtn.click(function() {
  contactList.add({
    id: Math.floor(Math.random()*110000),
    name: nameField.val(),
    age: ageField.val(),
    city: cityField.val()
  });
  clearFields();
  refreshCallbacks();
});

editBtn.click(function() {
  var item = contactList.get('id', idField.val())[0];
  item.values({
    id:idField.val(),
    name: nameField.val(),
    age: ageField.val(),
    city: cityField.val()
  });
  clearFields();
  editBtn.hide();
  addBtn.show();
});

function refreshCallbacks() {
  // Needed to add new buttons to jQuery-extended object
  removeBtns = $('.remove-item-btn');
  editBtns = $('.edit-item-btn');
  
  console.log(removeBtns);
  removeBtns.click(function() {
    var itemId = $(this).closest('tr').find('.id').text();
    contactList.remove('id', itemId);
  });
  
  editBtns.click(function() {
    var itemId = $(this).closest('tr').find('.id').text();
    var itemValues = contactList.get('id', itemId)[0].values();
    idField.val(itemValues.id);
    nameField.val(itemValues.name);
    ageField.val(itemValues.age);
    cityField.val(itemValues.city);
    
    editBtn.show();
    addBtn.hide();
  });
}

function clearFields() {
  nameField.val('');
  ageField.val('');
  cityField.val('');
}
	tinymce.init({ 
  		file_picker_callback: function(cb, value, meta) {
    var input = document.createElement('input');
    input.setAttribute('type', 'file');
    input.setAttribute('accept', 'image/*');
    
    // Note: In modern browsers input[type="file"] is functional without 
    // even adding it to the DOM, but that might not be the case in some older
    // or quirky browsers like IE, so you might want to add it to the DOM
    // just in case, and visually hide it. And do not forget do remove it
    // once you do not need it anymore.

    input.onchange = function() {
      var file = this.files[0];
      
      var reader = new FileReader();
      reader.onload = function () {
        // Note: Now we need to register the blob in TinyMCEs image blob
        // registry. In the next release this part hopefully won't be
        // necessary, as we are looking to handle it internally.
        var id = 'blobid' + (new Date()).getTime();
        var blobCache =  tinymce.activeEditor.editorUpload.blobCache;
        var base64 = reader.result.split(',')[1];
        var blobInfo = blobCache.create(id, file, base64);
        blobCache.add(blobInfo);

        // call the callback and populate the Title field with the file name
        cb(blobInfo.blobUri(), { title: file.name });
      };
      reader.readAsDataURL(file);
    };
    
    input.click();
  }
	, selector:'textarea', plugins: 'image media insertdatetime', external_plugins: {
				'mention' : 'http://stevendevooght.github.io/tinyMCE-mention/javascripts/tinymce/plugins/mention/plugin.js' }, 
		mentions: {
			source: function(query, process, delimeter) {

				var data = [];

				for (var i = 0; i < contactList.items.length; i++) {
					var obj = {};
					var name = contactList.items[i]._values.name;
					obj.name = name;
					data.push(obj);
				}
				// TODO: data from selects

				if (delimeter === '@')
					process(data);
			}
		}

	} );
	$('#remove-empty').click();
    </script>
  </body>
</html>
