<html>
	<head>
		<link rel='stylesheet' type='text/css' href='lib/bootstrap/css/bootstrap.min.css'>
		<link rel='stylesheet' type='text/css' href='src/css/style.css'>
		<script src='lib/jquery/jquery.js'></script>
		<script src='lib/jscolor/jscolor.js'></script>
		<script src='lib/popper/popper.js'></script>
		<script src='lib/bootstrap/js/bootstrap.min.js'></script>
		<script src='lib/teledraw/teledraw-canvas.js'></script>
		<script src='https://cdn.rawgit.com/naptha/tesseract.js/1.0.10/dist/tesseract.js'></script>
	</head>
	<body>
		<nav class='navbar navbar-default' id='navbar'>
			<img src='images/ecraft2learn.png' alt=''>
  			<div class='container-fluid'>
  				<input type='image' src='images/pencil.png' id='pen' class='navbar-btn'>
				<input type='image' src='images/eraser.png'  id='eraser' class='navbar-btn'>
				<input type='image' src='images/rect.png' id='rect' class='navbar-btn'>
				<input type='image' src='images/circle.png' id='ellipse' class='navbar-btn'>
				<input type='image' src='images/add.png' id='increase' class='navbar-btn'>
				<input type='image' src='images/remove.png' id='decrease' class='navbar-btn'>
				<input type='image' src='images/clear.png' id='clear' class='navbar-btn'>
				<input type='image' src='images/redo.png' id='redo' class='navbar-btn'>
				<input type='image' src='images/undo.png' id='undo' class='navbar-btn'>
				<input type='image' src='images/calculator.png' id='calculate' class='navbar-btn'>
				<input type='image' src='images/download.png' id='save' class='navbar-btn'>
				<form class='navbar-form navbar-right' role='search'>
        				<div class='form-group'>
						<input id='color' type='text' class='form-control jscolor nav-input'>
						<input id='calculator' disabled type='text' class='form-control nav-input' placeholder='Calculator value'>
					</div>
      				</form>
			</div>
		</nav>
		<div id='spacer'></div>
		<div id='canvases'>
			<canvas class='canvas' id='canvas-1'></canvas>
		</div>
		<div id='tooltip'>Moi</div>
		<img id='ocrad'>
		<style>
			#tooltip {

				display: inline-block;
				position: fixed;
				padding: .5em 1em;

			}
			
		</style>
		<script src='src/js/ui.js'></script>
		<script>

			var ApiCall = function() {

	var getQueryParam = function(param) {
    
    	var found;
    
    	window.location.search.substr(1).split("&").forEach(function(item) {
        
        	if (param ==  item.split("=")[0]) {
            
            	found = item.split("=")[1];
        
        	}
        	
    	});
    
    	return found;
	};

	this.url = 'https://cs.uef.fi/~tapanit/ecraft2learn/api/pilot_2/put_ideation_vectors_pilot_2.php';
	this.method = 'POST';
	
	this.sessionId = getQueryParam('sessionId');
	this.users = getQueryParam('users');

	this.data = {
	
		users: this.users,
		pen: 0,
		eraser: 0,
		rectangle: 0,
		circle: 0,
		add: 0,
		remove: 0,
		clear: 0,
		redo: 0,
		undo: 0,
		calculator: 0,
		download: 0,
		color: 0
	
	};
	
};

ApiCall.prototype.post = function() {

	var self = this;
	
	$.ajax({
        url: self.url,
        type: self.method,
        data: 'sessionId=' + self.sessionId + '&data=' + encodeURIComponent(JSON.stringify(self.data)),
        success: (data) => {
        
        	
        
        },
        error: (error) => {
        
        	console.log(error);
        
        }
    });

};

ApiCall.prototype.setData = function(key, data) {

	this.data[key] = data;

};

			$(document).ready(() => {

				$(document).on('mousemove', (event) => {

					$('#tooltip').contents().last().replaceWith(ui.getCanvas().state.strokeSize);

					$('#tooltip').css({
					
						left: event.pageX + 20,
						top: event.pageY - 20

					});

				});

				$('#color').val('000000');
				$('#color').css({ backgroundColor: 'black', color: 'white'  });

				window.onscroll = () => { scroll(); };

				var navbar = document.getElementById("navbar");

				var sticky = navbar.offsetTop;

				function scroll() {
  
					if (window.pageYOffset >= sticky) {
    						navbar.classList.add("sticky")
  					} else {
    						navbar.classList.remove("sticky");
  					}
				}
	
				var removeClasses = () => {

					$('#pen').removeClass('active-img');
					$('#eraser').removeClass('active-img');
					$('#rect').removeClass('active-img');
					$('#ellipse').removeClass('active-img');
					$('#increase').removeClass('active-img');
					$('#decrease').removeClass('active-img');
					$('#clear').removeClass('active-img');
					$('#redo').removeClass('active-img');
					$('#undo').removeClass('active-img');

				};

				var img = document.createElement('img');

				var ui = new UI();
				ui.addCanvas('canvas-1');
			
				var canvas = document.getElementById('canvas-1');

				img.addEventListener('load', (e) => {

					ui.getCanvas().fromDataURL(img.src, () => { console.log('jaa'); } );

				});

				$('#calculate').on('click', (e) => {
                        
					var request = new ApiCall();
					request.setData('calculator', 1);
					request.post();

                                        var data = ui.getCanvas().toDataURL();                              
 

					var image = new Image();
                                        image.src = data;
					
					image.onload = function() {
					
						Tesseract.recognize(image)
						.then(function(result){
						
							try {

								result.text = result.text.replace('x', '*');
								result.text = result.text.replace('X', '*');
								result.text = result.text.replace('~', '-');
								
								var res = (eval(result.text));
								$('#calculator').val(result.text + ' = ' + res);

							} catch (e) { $('#calculator').val('Error with: ' + result.text); }

						})		

					};
                                });

				canvas.addEventListener('dragover', function (evt) {

					evt.preventDefault();

				}, false);

				canvas.addEventListener('drop', function (evt) {

					var files = evt.dataTransfer.files;

					if (files.length > 0) {

						var file = files[0];

						if (typeof FileReader !== 'undefined' && file.type.indexOf('image') != -1) {

							var reader = new FileReader();

							reader.onload = function (evt) {

								img.src = evt.target.result;

							};

							reader.readAsDataURL(file);

						}

					}

					evt.preventDefault();

				}, false);  

				$('#pen').on('click', (e) => {

					var request = new ApiCall();
                                        request.setData('pen', 1);
                                        request.post();


					ui.getCanvas().setTool('pencil');

					removeClasses();
					$('#pen').addClass('active-img');


				});


				$('#save').on('click', (e) => {

					var request = new ApiCall();
                                        request.setData('download', 1);
                                        request.post();

					var data = ui.getCanvas().toDataURL();

					window.open(data, '_blank');


				});

				$('#eraser').on('click', (e) => {

					var request = new ApiCall();
                                        request.setData('eraser', 1);
                                        request.post();

					ui.getCanvas().setTool('eraser');

					removeClasses();
					$('#eraser').addClass('active-img');

				});

				$('#rect').on('click', (e) => {

					var request = new ApiCall();
                                        request.setData('rectangle', 1);
                                        request.post();

					ui.getCanvas().setTool('rectangle');

					removeClasses();
					$('#rect').addClass('active-img');

				});

				$('#ellipse').on('click', (e) => {

					var request = new ApiCall();
                                        request.setData('circle', 1);
                                        request.post();

					ui.getCanvas().setTool('ellipse');

					removeClasses();
					$('#ellipse').addClass('active-img');

				});

				$('#color').change((e) => {
				
					var request = new ApiCall();
                                        request.setData('color', 1);
                                        request.post();

					ui.getCanvas().setColor('#' + e.target.value);

				});

				$('#increase').on('click', (e) => {

					var request = new ApiCall();
                                        request.setData('add', 1);
                                        request.post();

					ui.getCanvas().setStrokeSize(ui.getCanvas().state.strokeSize + 500);

					removeClasses();
					$('#increase').addClass('active-img');

				});

				$('#decrease').on('click', (e) => {

					var request = new ApiCall();
                                        request.setData('remove', 1);
                                        request.post();

					ui.getCanvas().setStrokeSize(ui.getCanvas().state.strokeSize - 500);

					removeClasses();
					$('#decrease').addClass('active-img');

				});

				$('#clear').on('click', (e) => {

					var request = new ApiCall();
                                        request.setData('clear', 1);
                                        request.post();

					ui.getCanvas().clear();

					removeClasses();
					$('#clear').addClass('active-img');

				});


				$('#redo').on('click', (e) => {

					var request = new ApiCall();
                                        request.setData('redo', 1);
                                        request.post();

					ui.getCanvas().redo();

					removeClasses();
					$('#redo').addClass('active-img');

				});

				$('#undo').on('click', (e) => {

					var request = new ApiCall();
                                        request.setData('undo', 1);
                                        request.post();

					ui.getCanvas().undo();

					removeClasses();
					$('#undo').addClass('active-img');

				});

				/*
				$('#add').on('click', (e) => {

					e.preventDefault();
			
					var length = ui.getNumberOfCanvases() + 1;

					var id = 'canvas-' + length;

					var canvasStr = '<canvas class=\'canvas\' id=\'' + id + '\'></canvas>';

					$('#canvases').append($(canvasStr));
		
					ui.addCanvas(id);

				});

				$('#remove').on('click', (e) => {

					e.preventDefault();

					var canvas = ui.deleteCanvas();

					if (canvas) {

						var id = $(canvas.element).attr('id');

						$('#' + id).remove();

					}

				});
				*/
			
			});
		</script>
	</body>
</html>
